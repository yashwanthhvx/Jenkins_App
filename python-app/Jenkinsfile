pipeline {
  agent any

  parameters {
    choice(name: 'DEPLOYMENT_TYPE', choices: ['Docker-Compose', 'Kubernetes'], description: 'Choose the deployment type')
    string(name: 'TARGET_BRANCH', defaultValue: 'test', description: 'Specify the target branch')
  }

  tests {
    test('Build') {
      parallel {
        test('sourcecode') {
          steps {
            git branch: "stage", url: 'https://github.com/yashwanthhvx/Python_App.git'
            echo "Executing from branch: ${env.BRANCH_NAME}"
          }
        }
      }
    }

    test('Prepare') {
      steps {
        sh "sudo cp -R /var/lib/jenkins/workspace/Jenkins_App_test/python-app/* /var/lib/jenkins/workspace/Python_App_${params.TARGET_BRANCH}/Python-App/."
      }
    }

    test('Deploy') {
      parallel {
        test('Build Image') {
          steps {
            dir('Python-App') {
              sh 'sudo docker build -t python-app-test .'
              /* sh 'sudo docker run -d -p 8000:5000 --name python-app-test python-app-test' */
            }
          }
        }

        test('Docker Push') {
          steps {
            dir('Python-App') {
              sh 'sudo bash docker-credentials.sh'
              sh 'sudo docker tag python-app-test hvxuser/python-app-test'
              sh 'sudo docker push hvxuser/python-app-test'
            }
          }
        }

        test('Docker-Compose') {
          when {
            expression { params.DEPLOYMENT_TYPE == 'Docker-Compose' }
          }
          steps {
            dir('Python-App') {
              sh 'sudo docker-compose up -d'
            }
          }
        }

        test('K8-Deploy') {
          when {
            expression { params.DEPLOYMENT_TYPE == 'Kubernetes' }
          }
          steps {
            dir('Python-App') {
              script {
                def deployCmd = 'sudo kubectl apply -f k8-deployment.yml'
                def deployStatus = sh(script: deployCmd, returnStatus: true)

                if (deployStatus == 0) {
                  echo 'Kubernetes deployment succeeded'
                } else {
                  echo 'Kubernetes deployment failed'
                  currentBuild.result = 'FAILURE'
                }
              }
            }
          }
        }
      }
    }
  }
}
